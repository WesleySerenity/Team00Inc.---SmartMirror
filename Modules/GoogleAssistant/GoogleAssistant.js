
var logGA=(...s)=>{};Module.register("MMM-GoogleAssistant",{requiresVersion:"2.25.0",defaults:{debug:!1,stopCommand:"stop",otherStopCommands:[],assistantConfig:{lang:"en-US",latitude:51.50853,longitude:-.076132,deviceRegistred:!1},responseConfig:{useFullscreen:!1,responseOutputCSS:"response_output.css",screenOutputTimer:5e3,useChime:!0,confirmationChime:!0,chimes:{beep:"beep.mp3",error:"error.mp3",continue:"continue.mp3",confirmation:"confirmation.mp3",open:"Google_beep_open.mp3",close:"Google_beep_close.mp3",opening:"opening.mp3",closing:"closing.mp3",warning:"warning.ogg"},imgStatus:{hook:"hook.gif",standby:"standby.gif",reply:"reply.gif",error:"error.gif",think:"think.gif",continue:"continue.gif",listen:"listen.gif",confirmation:"confirmation.gif",information:"information.gif",warning:"warning.gif",userError:"userError.gif"},zoom:{transcription:"80%",responseOutput:"60%"}},recipes:[],website:{use:!0,username:"admin",password:"admin",CLIENT_ID:null}},getScripts(){return["/modules/MMM-GoogleAssistant/components/assistantResponse.js","/modules/MMM-GoogleAssistant/components/assistantSearch.js","/modules/MMM-GoogleAssistant/components/EXTs.js","/modules/MMM-GoogleAssistant/components/sysInfoPage.js"]},getStyles(){return["/modules/MMM-GoogleAssistant/MMM-GoogleAssistant.css"]},getTranslations(){return{en:"translations/en.json",de:"translations/de.json",el:"translations/el.json",es:"translations/es.json",fr:"translations/fr.json",it:"translations/it.json",ko:"translations/ko.json",nl:"translations/nl.json",pt:"translations/pt.json",tr:"translations/tr.json","zh-cn":"translations/zh-cn.json"}},getDom(){var s=document.createElement("div");return s.style.display="none",s},notificationReceived(s,t=null,i=null){if(this.doPlugin("onNotificationReceived",{notification:s,payload:t}),s.startsWith("EXT_")&&this.EXTs)return this.EXTs.ActionsEXTs(s,t,i);switch(s){case"GA_ACTIVATE":t&&t.type&&t.key?this.assistantActivate(t):this.assistantActivate({type:"MIC"});break;case"GA_FORCE_FULLSCREEN":if(this.config.responseConfig.useFullscreen)return logGA("Force Fullscreen: Already activated");this.config.responseConfig.useFullscreen=!0,this.assistantResponse=null,this.assistantResponse=new AssistantResponse(this.helperConfig.responseConfig,this.callbacks),logGA("Force Fullscreen: AssistantResponse Reloaded");break;case"GA_STOP":this.assistantResponse.response&&this.GAStatus.actual==="reply"&&this.assistantResponse.conversationForceEnd();break}},socketNotificationReceived(s,t){if(s.startsWith("CB_"))return this.EXTs.callbacks(s,t);switch(s){case"LOAD_RECIPE":this.parseLoadedRecipe(t);break;case"NOT_INITIALIZED":this.assistantResponse.fullscreen(!0),this.assistantResponse.showError(this.translate(t.message,{VALUES:t.values})),this.assistantResponse.forceStatusImg("userError");break;case"WARNING":this.sendNotification("EXT_ALERT",{message:this.translate(t),type:"warning",timer:1e4});break;case"INFORMATION":break;case"ERROR":this.sendNotification("EXT_ALERT",{message:this.translate(t),type:"error"});break;case"RECIPE_ERROR":this.sendNotification("EXT_ALERT",{message:this.translate("GAErrorRecipe",{VALUES:t}),type:"error"});break;case"GA-INIT":this.EXT_Config();break;case"WEBSITE-INIT":this.sendSocketNotification("SMARTHOME-INIT");break;case"INITIALIZED":logGA("Initialized."),this.assistantResponse.Version(t),this.assistantResponse.status("standby"),this.doPlugin("onReady"),this.EXTs.setGA_Ready(),this.sendNotification("GA_READY");break;case"ASSISTANT_RESULT":t.volume!==null&&this.sendNotification("EXT_VOLUME-SPEAKER_SET",t.volume),this.assistantResponse.start(t);break;case"TUNNEL":this.assistantResponse.tunnel(t);break;case"ASSISTANT_ACTIVATE":this.assistantActivate(t);break;case"GOOGLESEARCH-RESULT":this.sendGoogleResult(t);break;case"REMOTE_ACTIVATE_ASSISTANT":this.notificationReceived("GA_ACTIVATE",t);break;case"TB_SYSINFO-RESULT":this.show_sysinfo(t);break;case"SYSINFO-RESULT":this.sysInfo.updateSystemData(t);break;case"SendNoti":t.payload&&t.noti?this.sendNotification(t.noti,t.payload):this.sendNotification(t);break;case"SendStop":this.EXTs.ActionsEXTs("EXT_STOP");break}},start(){const s=["debug","recipes","assistantConfig","responseConfig","website"];this.config.debug&&(logGA=(...e)=>{console.log("[GA]",...e)}),this.helperConfig={};for(var t=0;t<s.length;t++)this.helperConfig[s[t]]=this.config[s[t]];this.helperConfig.micConfig={recorder:"auto",device:"default"},this.forceResponse=!1,this.assistantResponse=null,this.globalStopCommands=[],Array.isArray(this.config.otherStopCommands)&&(this.globalStopCommands=this.config.otherStopCommands),this.GAStatus={actual:"standby",old:"standby"},this.plugins={onReady:[],onNotificationReceived:[],onActivate:[],onStatus:[]},this.commands={},this.transcriptionHooks={},this.responseHooks={},this.callbacks={assistantActivate:e=>{this.assistantActivate(e)},postProcess:(e,n,o)=>{this.postProcess(e,n,o)},endResponse:()=>{logGA("Conversation Done")},translate:e=>this.translate(e),GAStatus:e=>{this.doPlugin("onStatus",{status:e}),this.GAStatus=e,this.sendNotification(`ASSISTANT_${this.GAStatus.actual.toUpperCase()}`),this.EXTs.ActionsGA(this.GAStatus.actual.toUpperCase())},Gateway:e=>this.ScanResponse(e),sendSocketNotification:(e,n)=>{this.sendSocketNotification(e,n)}},this.assistantResponse=new AssistantResponse(this.helperConfig.responseConfig,this.callbacks),this.AssistantSearch=new AssistantSearch(this.helperConfig.assistantConfig),this.assistantResponse.prepareGA(),this.assistantResponse.prepareBackground(),this.assistantResponse.Loading();var i={commands:{EXT_Stop:{notificationExec:{notification:"EXT_STOP"},soundExec:{chime:"close"},displayResponse:!1}}};this.parseLoadedRecipe(JSON.stringify(i)),logGA("[HOOK] EXT_Stop Command Added"),this.globalStopCommands.indexOf(this.config.stopCommand)===-1&&this.globalStopCommands.push(this.config.stopCommand),this.globalStopCommands.length?this.globalStopCommands.forEach((e,n)=>{var o={transcriptionHooks:{}};o.transcriptionHooks[`EXT_Stop${n}`]={pattern:`^(${e})($)`,command:"EXT_Stop"},this.parseLoadedRecipe(JSON.stringify(o)),logGA(`[HOOK] Add pattern for EXT_Stop command: ${e}`)}):console.error("[GA] No Stop Commands defined!"),this.sendSocketNotification("PRE-INIT",this.helperConfig)},async EXT_Config(){const s={translate:(...i)=>this.translate(...i),sendNotification:(...i)=>this.sendNotification(...i),sendSocketNotification:(...i)=>this.sendSocketNotification(...i),socketNotificationReceived:(...i)=>this.socketNotificationReceived(...i),notificationReceived:(...i)=>this.notificationReceived(...i),lock:()=>this.EXTs.forceLockPagesAndScreen(),unLock:()=>this.EXTs.forceUnLockPagesAndScreen()};this.EXTs=new EXTs(s),await this.EXTs.init()&&(this.session={},this.sysInfo=new sysInfoPage(s),this.sysInfo.prepare(),this.sendSocketNotification("WEBSITE-INIT",{DB:this.EXTs.ExtDB,Description:this.EXTs.Get_EXT_Description(),Translate:this.EXTs.Get_EXT_Translation(),Schema:this.EXTs.Get_EXT_TrSchemaValidation(),EXTStatus:this.EXTs.Get_EXT_Status()}))},EXT_TELBOTCommands(s){s.add({command:"query",description:this.translate("QUERY_HELP"),callback:"tbQuery"}),s.add({command:"stop",description:this.translate("STOP_HELP"),callback:"tbStopEXT"}),this.config.website.use&&s.add({command:"sysinfo",description:this.translate("TB_SYSINFO_DESCRIPTION"),callback:"cmd_sysinfo"})},tbQuery(s,t){var i=t.args;i?this.assistantActivate({type:"TEXT",key:i}):t.reply("TEXT",this.translate("QUERY_HELP"))},tbStopEXT(s,t){this.sendNotification("EXT_STOP"),t.reply("TEXT",this.translate("STOP_EXT"))},cmd_sysinfo(s,t){if(t.args){var i=t.args.toLowerCase().split(" "),e=t.args.split(" ");if(i[0]==="show"){this.sysInfo.show(),t.reply("TEXT","ok.");return}if(i[0]==="hide"){this.sysInfo.hide(),t.reply("TEXT","ok.");return}}let n=t.message.chat.id,o=t.message.from.id,r=`${t.message.message_id}:${o}:${n}`;this.session[r]=t,this.sendSocketNotification("TB_SYSINFO",r)},show_sysinfo(s){let t=s.sessionId,i=this.session[t];if(!i||!t)return console.error("[Gateway] TB session not found!",i,t);var e="";e+=`*${s.HOSTNAME}*

`,e+=`*-- ${this.translate("GW_System_Box_Version")} --*
`,e+=`*MMM-GoogleAssistant:* \`${s.VERSION.GA}\`
`,e+=`*MagicMirror\xB2:* \`${s.VERSION.MagicMirror}\`
`,e+=`*Electron:* \`${s.VERSION.ELECTRON}\`
`,e+=`*MagicMirror\xB2 ${this.translate("GW_System_NodeVersion")}* \`${s.VERSION.NODEMM}\`
`,e+=`*${this.translate("GW_System_NodeVersion")}* \`${s.VERSION.NODECORE}\`
`,e+=`*${this.translate("GW_System_NPMVersion")}* \`${s.VERSION.NPM}\`
`,e+=`*${this.translate("GW_System_OSVersion")}* \`${s.VERSION.OS}\`
`,e+=`*${this.translate("GW_System_KernelVersion")}* \`${s.VERSION.KERNEL}\`
`,e+=`*-- GPU --*
`;let n=s.GPU?this.translate("GW_System_GPUAcceleration_Enabled"):`WARN: ${this.translate("GW_System_GPUAcceleration_Disabled")}`;e+=`*${n}*
`,e+=`*-- ${this.translate("GW_System_CPUSystem")} --*
`,e+=`*${this.translate("GW_System_TypeCPU")}* \`${s.CPU.type}\`
`,e+=`*${this.translate("GW_System_SpeedCPU")}* \`${s.CPU.speed}\`
`,e+=`*${this.translate("GW_System_CurrentLoadCPU")}* \`${s.CPU.usage}%\`
`,e+=`*${this.translate("GW_System_GovernorCPU")}* \`${s.CPU.governor}\`
`,e+=`*${this.translate("GW_System_TempCPU")}* \`${config.units==="metric"?s.CPU.temp.C:s.CPU.temp.F}\xB0\`
`,e+=`*-- ${this.translate("GW_System_MemorySystem")} --*
`,e+=`*${this.translate("GW_System_TypeMemory")}* \`${s.MEMORY.used} / ${s.MEMORY.total} (${s.MEMORY.percent}%)\`
`,e+=`*${this.translate("GW_System_SwapMemory")}* \`${s.MEMORY.swapUsed} / ${s.MEMORY.swapTotal} (${s.MEMORY.swapPercent}%)\`
`,e+=`*-- ${this.translate("GW_System_NetworkSystem")} --*
`,e+=`*${this.translate("GW_System_IPNetwork")}* \`${s.NETWORK.ip}\`
`,e+=`*${this.translate("GW_System_InterfaceNetwork")}* \`${s.NETWORK.name} (${s.NETWORK.type==="wired"?this.translate("TB_SYSINFO_ETHERNET"):this.translate("TB_SYSINFO_WLAN")})\`
`,s.NETWORK.type==="wired"?(e+=`*${this.translate("GW_System_SpeedNetwork")}* \`${s.NETWORK.speed} Mbit/s\`
`,e+=`*${this.translate("GW_System_DuplexNetwork")}* \`${s.NETWORK.duplex}\`
`):(e+=`*${this.translate("GW_System_WirelessInfo")}:*
`,e+=`*  ${this.translate("GW_System_SSIDNetwork")}* \`${s.NETWORK.ssid}\`
`,e+=`*  ${this.translate("GW_System_FrequencyNetwork")}* \`${s.NETWORK.frequency} GHz\`
`,e+=`*  ${this.translate("GW_System_RateNetwork")}* \`${s.NETWORK.rate} Mb/s\`
`,e+=`*  ${this.translate("GW_System_QualityNetwork")}* \`${s.NETWORK.quality}\`
`,e+=`*  ${this.translate("GW_System_SignalNetwork")}* \`${s.NETWORK.signalLevel} dBm (${s.NETWORK.barLevel})\`
`),e+=`*-- ${this.translate("GW_System_StorageSystem")} --*
`,s.STORAGE.forEach(o=>{for(let[a,r]of Object.entries(o))e+=`*${this.translate("GW_System_MountStorage")} ${a}:* \`${r.used} / ${r.size} (${r.use}%)\`
`}),e+=`*-- ${this.translate("GW_System_UptimeSystem")} --*
`,e+=`*${this.translate("GW_System_CurrentUptime")}:*
`,e+=`*  ${this.translate("GW_System_System")}* \`${s.UPTIME.currentDHM}\`
`,e+=`*  MagicMirror\xB2:* \`${s.UPTIME.MMDHM}\`
`,e+=`*${this.translate("GW_System_RecordUptime")}:*
`,e+=`*  ${this.translate("GW_System_System")}* \`${s.UPTIME.recordCurrentDHM}\`
`,e+=`*  MagicMirror\xB2:* \`${s.UPTIME.recordMMDHM}\`
`,i.reply("TEXT",e,{parse_mode:"Markdown"}),delete this.session[t]},assistantActivate(s){if(this.GAStatus.actual!=="standby"&&!s.force)return logGA("Assistant is busy.");this.assistantResponse.clearAliveTimers(),this.GAStatus.actual==="continue"?this.assistantResponse.showTranscription(this.translate("GAContinue")):this.assistantResponse.showTranscription(this.translate("GABegin")),this.doPlugin("onActivate"),this.assistantResponse.fullscreen(!0),this.lastQuery=null;var t={type:"TEXT",key:null,lang:this.config.assistantConfig.lang,status:this.GAStatus.old,chime:!0};t=Object.assign({},t,s),this.assistantResponse.status(t.type,!!t.chime),this.sendSocketNotification("ACTIVATE_ASSISTANT",t)},postProcess(s,t=()=>{},i=()=>{}){if(s.lastQuery.status==="continue")return i();var e=this.findAllHooks(s);if(e.length>0){this.assistantResponse.status("hook");for(var n=0;n<e.length;n++){var o=e[n];this.doCommand(o.command,o.params,o.from)}this.forceResponse?(this.forceResponse=!1,i()):t()}else i()},ScanResponse(s){if(s.screen&&(s.screen.links.length>0||s.screen.photos.length>0)){let t={photos:s.screen.photos,urls:s.screen.links,youtube:null};logGA("Send response:",t),this.notificationReceived("EXT_GATEWAY",t)}else s.text&&(this.AssistantSearch.GoogleSearch(s.text)?this.sendSocketNotification("GOOGLESEARCH",s.transcription.transcription):this.AssistantSearch.YouTubeSearch(s.text)&&(logGA("Send response YouTube:",s.transcription.transcription),this.notificationReceived("EXT_GATEWAY",{photos:[],urls:[],youtube:s.transcription.transcription})))},sendGoogleResult(s){if(!s)return console.error("[GA] No link to open!");logGA("Send response:",s),this.notificationReceived("EXT_GATEWAY",{photos:[],urls:[s],youtube:null})},findAllHooks(s){var t=[];return t=t.concat(this.findTranscriptionHook(s)),t=t.concat(this.findResponseHook(s)),this.findNativeAction(s),t},findResponseHook(s){var t=[];if(s.screen){var i=[];i.links=s.screen.links?s.screen.links:[],i.text=s.screen.text?[].push(s.screen.text):[],i.photos=s.screen.photos?s.screen.photos:[];for(var e in this.responseHooks)if(this.responseHooks.hasOwnProperty(e)){var n=this.responseHooks[e];if(!(!n.where||!n.pattern||!n.command)){var o=new RegExp(n.pattern,"ig"),a=o.exec(i[n.where]);a&&(t.push({from:e,params:a,command:n.command}),logGA("ResponseHook matched:",e))}}}return t},findTranscriptionHook(s){var t=[],i=s.transcription?s.transcription.transcription:"";for(var e in this.transcriptionHooks)if(this.transcriptionHooks.hasOwnProperty(e)){var n=this.transcriptionHooks[e];if(n.pattern&&n.command){var o=new RegExp(n.pattern,"ig"),a=o.exec(i);a&&(t.push({from:e,params:a,command:n.command}),logGA("TranscriptionHook matched:",e))}else{logGA(`TranscriptionHook:${e} has invalid format`);continue}}return t},doCommand(s,t,i){if(this.commands.hasOwnProperty(s)){var e=this.commands[s];e.displayResponse&&(this.forceResponse=!0)}else{logGA(`Command ${s} is not found.`);return}var n=typeof t=="object"?Object.assign({},t):t;if(e.hasOwnProperty("notificationExec")){var o=e.notificationExec;if(o.notification){var a=typeof o.notification=="function"?o.notification(n,i):o.notification,r=o.payload?typeof o.payload=="function"?o.payload(n,i):o.payload:null,E=typeof r=="object"?Object.assign({},r):r;logGA(`Command ${s} is executed (notificationExec).`),this.sendNotification(a,E)}}if(e.hasOwnProperty("shellExec")){var h=e.shellExec;if(h.exec){var g=typeof h.exec=="function"?h.exec(n,i):h.exec,f=h.options?typeof h.options=="function"?h.options(n,i):h.options:null,S=typeof f=="function"?f(n):f;g&&(logGA(`Command ${s} is executed.`),this.sendSocketNotification("SHELLEXEC",{command:g,options:S}))}}if(e.hasOwnProperty("moduleExec")){var l=e.moduleExec,m=typeof l.module=="function"?l.module(n,i):l.module,u=Array.isArray(m)?m:new Array(m);typeof l.exec=="function"&&MM.getModules().enumerate(d=>{(u.length===0||u.indexOf(d.name)>=0)&&(logGA(`Command ${s} is executed (moduleExec) for :`,d.name),l.exec(d,n,i))})}if(e.hasOwnProperty("soundExec")){var c=e.soundExec;c.chime&&typeof c.chime=="string"&&(c.chime==="open"&&this.assistantResponse.playChime("open"),c.chime==="close"&&this.assistantResponse.playChime("close"),c.chime==="opening"&&this.assistantResponse.playChime("opening"),c.chime==="closing"&&this.assistantResponse.playChime("closing")),c.sound&&typeof c.sound=="string"&&this.assistantResponse.playChime(c.sound,!0)}},parseLoadedRecipe(payload){let reviver=(key,value)=>{if(typeof value=="string"&&value.indexOf("__FUNC__")===0){let Value=value.slice(8),functionTemplate=`(${Value})`;return eval(functionTemplate)}return value};var p=JSON.parse(payload,reviver);p.hasOwnProperty("commands")&&this.registerCommandsObject(p.commands),p.hasOwnProperty("transcriptionHooks")&&this.registerTranscriptionHooksObject(p.transcriptionHooks),p.hasOwnProperty("responseHooks")&&this.registerResponseHooksObject(p.responseHooks),p.hasOwnProperty("plugins")&&this.registerPluginsObject(p.plugins)},doPlugin(s,t){if(this.plugins.hasOwnProperty(s)){var i=this.plugins[s];if(Array.isArray(i)&&i.length>0)for(var e=0;e<i.length;e++){var n=i[e];this.doCommand(n,t,s)}}},registerPluginsObject(s){for(var t in this.plugins)if(s.hasOwnProperty(t)){var i=[];Array.isArray(s[t])?i=i.concat(s[t]):i.push(s[t].toString());for(var e=0;e<i.length;e++)this.registerPlugin(t,i[e])}},registerPlugin(s,t){this.plugins.hasOwnProperty(s)&&(Array.isArray(t)&&this.plugins[s].concat(t),this.plugins[s].push(t))},registerCommandsObject(s){this.commands=Object.assign({},this.commands,s)},registerTranscriptionHooksObject(s){this.transcriptionHooks=Object.assign({},this.transcriptionHooks,s)},registerResponseHooksObject(s){this.responseHooks=Object.assign({},this.responseHooks,s)},findNativeAction(s){var t=s.action?s.action:null;!t||!t.inputs||t.inputs.forEach(i=>{i.intent==="action.devices.EXECUTE"&&i.payload.commands.forEach(e=>{e.execution.forEach(n=>{logGA(`Native Action: ${n.command}`,n.params),n.command==="action.devices.commands.SetVolume"&&(logGA("Volume Control:",n.params.volumeLevel),this.sendNotification("EXT_VOLUME-SPEAKER_SET",n.params.volumeLevel))})})})}});

